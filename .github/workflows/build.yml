name: Build GKI Kernel Modules (4.19, 5.4, 5.10, 5.15, 6.1)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel ${{ matrix.kernel-version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # Android 10/11 (Legacy Stable) - Added 4.19
          - kernel-version: 4.19.312
            branch: android-4.19
            config: gki_defconfig # Часто используется gki_defconfig, но если нужен perf, раскомментируй ниже
            # config: perf_defconfig 

          # Android 11 (Legacy GKI)
          - kernel-version: 5.4
            branch: android11-5.4
            config: gki_defconfig
            
          # Android 12/13 (Stable)
          - kernel-version: 5.10
            branch: android12-5.10
            config: gki_defconfig

          # Android 14 (Current)
          - kernel-version: 5.15
            branch: android14-5.15
            config: gki_defconfig
            
          # Android 14/15 (Latest)
          - kernel-version: 6.1
            branch: android14-6.1
            config: gki_defconfig

    steps:
    - name: Checkout driver source
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev \
                                python3 python3-pip git wget lld llvm \
                                libelf-dev

    - name: Setup Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        echo "$GITHUB_WORKSPACE/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Clone GKI kernel (${{ matrix.branch }})
      run: |
        git clone --depth 1 --branch ${{ matrix.branch }} https://android.googlesource.com/kernel/common gki-kernel

    - name: Integrate driver into kernel tree
      run: |
        cd gki-kernel
        mkdir -p drivers/khack
        cp $GITHUB_WORKSPACE/driver-src/kernel/* drivers/khack/
        
        cat > drivers/khack/Kconfig <<-'EOF'
        config KERNEL_HACK
            tristate "JiangNight Memory Hack Driver"
            default m
        EOF
        
        cat > drivers/khack/Makefile <<-'EOF'
        obj-$(CONFIG_KERNEL_HACK) += jiangnight.o
        jiangnight-objs := entry.o 
        EOF
        
        echo 'source "drivers/khack/Kconfig"' >> drivers/Kconfig
        echo 'obj-$(CONFIG_KERNEL_HACK) += khack/' >> drivers/Makefile

    - name: Configure and Build
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
        CROSS_COMPILE: aarch64-linux-android-
        CLANG_TRIPLE: aarch64-linux-gnu-
      run: |
        cd gki-kernel
        
        # Специальная обработка для старых ядер (4.19), где могут быть нюансы с конфигом
        if [[ "${{ matrix.kernel-version }}" == "4.19"* ]]; then
             echo "Applying fixes for 4.19..."
             # Иногда нужно явно отключить проверку версий модулей для хак-драйверов
             echo "CONFIG_MODVERSIONS=n" >> out/.config
        fi

        # 1. Конфигурация
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS \
             CROSS_COMPILE=$CROSS_COMPILE CLANG_TRIPLE=$CLANG_TRIPLE \
             ${{ matrix.config }}
        
        # 2. Включаем модуль
        echo "CONFIG_KERNEL_HACK=m" >> out/.config
        
        # Обновляем конфиг
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS \
             CROSS_COMPILE=$CROSS_COMPILE CLANG_TRIPLE=$CLANG_TRIPLE \
             olddefconfig
        
        # 3. Подготовка
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS \
             CROSS_COMPILE=$CROSS_COMPILE CLANG_TRIPLE=$CLANG_TRIPLE \
             -j$(nproc) modules_prepare
        
        # 4. Сборка модуля
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS \
             CROSS_COMPILE=$CROSS_COMPILE CLANG_TRIPLE=$CLANG_TRIPLE \
             -j$(nproc) M=drivers/khack

    - name: Upload module
      uses: actions/upload-artifact@v4
      with:
        name: jiangnight-${{ matrix.kernel-version }}.ko
        path: gki-kernel/out/**/jiangnight.ko
        if-no-files-found: error
