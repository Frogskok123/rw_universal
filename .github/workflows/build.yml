
name: Build bLKM for 5.10.136

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev gcc-aarch64-linux-gnu

      - name: Clone Kernel
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android12-5.10 kernel

      - name: Create Files
        run: |
          cat > rw_universal.c << 'EOF'
          #define pr_fmt(fmt) "rw_universal: " fmt
          #include <linux/init.h>
          #include <linux/module.h>
          #include <linux/mm.h>
          #include <linux/kallsyms.h>
          #include <linux/kprobes.h>
          #include <asm/pgtable.h>
          #include <linux/pagewalk.h>

          MODULE_LICENSE("GPL");

          static unsigned long resolve_ksym(const char *name) {
              struct kprobe kp = { .symbol_name = name };
              unsigned long addr;
              if (register_kprobe(&kp) < 0) return 0;
              addr = (unsigned long)kp.addr;
              unregister_kprobe(&kp);
              pr_info("Found %s at %px", name, (void *)addr);
              return addr;
          }

          static struct mm_struct *init_mm_ptr = NULL;

          typedef struct { phys_addr_t phys; bool valid; } v2p_t;

          static int walker(pte_t *pte, unsigned long addr, unsigned long next, struct mm_walk *walk) {
              v2p_t *v = walk->private;
              if (pte_present(*pte)) {
                  v->phys = (pte_pfn(*pte) << PAGE_SHIFT) | (addr & ~PAGE_MASK);
                  v->valid = true;
                  return 1;
              }
              return 0;
          }

          static const struct mm_walk_ops v2p_walk_ops = { .pte_entry = walker };

          static int __init rw_init(void) {
              init_mm_ptr = (void *)resolve_ksym("init_mm");
              if (!init_mm_ptr) return -ENODEV;
              list_del_init(&THIS_MODULE->list);
              pr_info("Module loaded");
              return 0;
          }

          static void __exit rw_exit(void) { }

          module_init(rw_init);
          module_exit(rw_exit);
          EOF
          
          cat > Makefile << 'EOF'
          obj-m := rw_universal.o
          EOF

      - name: Build
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          make defconfig
          echo "CONFIG_MODULES=y" >> .config
          echo "CONFIG_MODULE_UNLOAD=y" >> .config
          echo "# CONFIG_MODULE_SIG is not set" >> .config
          echo "# CONFIG_MODVERSIONS is not set" >> .config
          
          make olddefconfig
          make modules_prepare
          
          cd ..
          make -C kernel M=$PWD modules
          
          ls -lh *.ko
          file rw_universal.ko

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: rw_universal
          path: rw_universal.ko
