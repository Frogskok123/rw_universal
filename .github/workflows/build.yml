name: Build Universal LKM (5.10-android12) – clang

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        # libssl-dev обязателен для работы скриптов подписи модулей ядра
        run: sudo apt update && sudo apt install -y git bc bison flex build-essential zip libssl-dev

      - name: Clone AOSP kernel (Android 12 / 5.10)
        run: |
          mkdir -p kernel
          git clone --depth=1 https://android.googlesource.com/kernel/common \
            -b android12-5.10 kernel/android12-5.10

      - name: Install NDK r25c
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip
          rm android-ndk-r25c-linux.zip

      - name: Configure and Prepare Kernel
        run: |
          cd kernel/android12-5.10
          export PATH=$GITHUB_WORKSPACE/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          
          # 1. Создаем конфигурацию (.config)
          make ARCH=arm64 \
               LLVM=1 \
               LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-android- \
               defconfig
          
          # 2. ВАЖНО: Генерируем asm-offsets.h и заголовки.
          # Без этого шага сборка модуля падает с ошибкой 'awk: fatal: cannot open file...'
          make ARCH=arm64 \
               LLVM=1 \
               LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-android- \
               modules_prepare

      - name: Build module
        run: |
          export PATH=$GITHUB_WORKSPACE/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          
          # Сборка внешнего модуля
          # -C указывает путь к исходникам ядра
          # M=$GITHUB_WORKSPACE указывает путь к вашему коду (корню репозитория)
          make -C kernel/android12-5.10 \
               M=$GITHUB_WORKSPACE \
               ARCH=arm64 \
               LLVM=1 \
               LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-android- \
               modules

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rw_universal.ko
          path: rw_universal.ko

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: rw_universal.ko
          title: Release ${{ github.ref_name }}
