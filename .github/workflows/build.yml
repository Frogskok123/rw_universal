name: Build Universal LKM (5.10-android12) â€“ clang

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: sudo apt update && sudo apt install -y git bc bison flex build-essential zip

      - name: Clone AOSP kernel
        run: |
          mkdir -p kernel
          git clone --depth=1 https://android.googlesource.com/kernel/common \
            -b android12-5.10 kernel/android12-5.10

      - name: Install NDK r25c
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q android-ndk-r25c-linux.zip

       - name: Configure kernel
         run: |
          cd kernel/android12-5.10
          export PATH=$PWD/../../android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          make ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-android21- defconfig


      - name: Build module
        run: |
          export PATH=$PWD/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          export ARCH=arm64
          export CC=clang
          export CROSS_COMPILE=aarch64-linux-android21-
          make -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rw_universal-unsigned.ko
          path: rw_universal.ko

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: rw_universal.ko
          title: Release ${{ github.ref_name }}

