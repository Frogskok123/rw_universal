name: Build Kernel Modules (Alioth 4.19 + GKI)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.kernel-version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Custom Kernels ---
          
          # POCO F3 (Alioth) - Kernel 4.19
          - kernel-version: 4.19-alioth
            repo_url: https://github.com/raystef66/InfiniR_kernel_alioth
            branch: user # Или 'main', проверь в репо. Обычно 'user' или 'eleven'
            config: alioth_defconfig
            arch: arm64
            llvm_ver: 12 # Для 4.19 нужен старый Clang

          # --- Google GKI ---

          # Android 12 (5.10)
          - kernel-version: 5.10-gki
            repo_url: https://android.googlesource.com/kernel/common
            branch: android12-5.10
            config: gki_defconfig
            arch: arm64
            llvm_ver: 14

          # Android 14 (6.1)
          - kernel-version: 6.1-gki
            repo_url: https://android.googlesource.com/kernel/common
            branch: android14-6.1
            config: gki_defconfig
            arch: arm64
            llvm_ver: 17

    steps:
    - name: Checkout driver source
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev \
                                python3 python3-pip git wget lld llvm \
                                libelf-dev

    - name: Setup Clang/LLVM
      run: |
        # Скачиваем AOSP Clang подходящей версии
        mkdir -p clang
        if [[ "${{ matrix.llvm_ver }}" == "12" ]]; then
           wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r416183b.tar.gz -O clang.tar.gz
        else
           # Дефолтный новый Clang для GKI
           wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r487747c.tar.gz -O clang.tar.gz
        fi
        tar -xf clang.tar.gz -C clang
        echo "$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_PATH

    - name: Clone Kernel Source
      run: |
        git clone --depth 1 --branch ${{ matrix.branch }} ${{ matrix.repo_url }} kernel-source

    - name: Setup KernelSU (for Alioth)
      if: matrix.kernel-version == '4.19-alioth'
      run: |
        cd kernel-source
        # Alioth ядро требует KSU setup
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Integrate Driver
      run: |
        cd kernel-source
        mkdir -p drivers/khack
        cp -r $GITHUB_WORKSPACE/driver-src/kernel/* drivers/khack/
        
        # Создаем Kconfig/Makefile, если их нет в исходниках драйвера
        echo 'config KERNEL_HACK' > drivers/khack/Kconfig
        echo '    tristate "JiangNight Hack"' >> drivers/khack/Kconfig
        echo '    default m' >> drivers/khack/Kconfig
        
        echo 'obj-$(CONFIG_KERNEL_HACK) += jiangnight.o' > drivers/khack/Makefile
        echo 'jiangnight-objs := entry.o' >> drivers/khack/Makefile
        
        # Добавляем в дерево
        if grep -q "drivers/khack" drivers/Kconfig; then
           echo "Already integrated"
        else
           echo 'source "drivers/khack/Kconfig"' >> drivers/Kconfig
           echo 'obj-$(CONFIG_KERNEL_HACK) += khack/' >> drivers/Makefile
        fi

    - name: Build Module
      env:
        ARCH: ${{ matrix.arch }}
        CROSS_COMPILE: aarch64-linux-gnu-
        CROSS_COMPILE_ARM32: arm-linux-gnueabi-
        CC: clang
        LD: ld.lld
        AR: llvm-ar
        NM: llvm-nm
        OBJCOPY: llvm-objcopy
        OBJDUMP: llvm-objdump
        STRIP: llvm-strip
      run: |
        cd kernel-source
        
        # 1. Config
        # Для Alioth конфиг лежит в arch/arm64/configs/vendor/alioth_defconfig или просто alioth_defconfig
        # Проверим где он
        if [ -f "arch/arm64/configs/vendor/${{ matrix.config }}" ]; then
            make O=out vendor/${{ matrix.config }}
        else
            make O=out ${{ matrix.config }}
        fi
        
        # 2. Enable Module
        echo "CONFIG_KERNEL_HACK=m" >> out/.config
        make O=out olddefconfig
        
        # 3. Build
        make O=out -j$(nproc) modules_prepare
        make O=out -j$(nproc) M=drivers/khack modules

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: module-${{ matrix.kernel-version }}.ko
        path: kernel-source/out/drivers/khack/*.ko
