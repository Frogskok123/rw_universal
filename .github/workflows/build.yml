name: Build Universal LKM (5.10-android12) – proton-clang

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential zip curl libssl-dev python3 git gcc-aarch64-linux-gnu

      - name: Download Proton Clang
        run: |
          # Скачиваем проверенный toolchain, который содержит все нужные бинарники (clang, ld.lld и т.д.)
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Clone AOSP Kernel
        run: |
          # Используем ветку android12-5.10
          git clone --depth=1 https://android.googlesource.com/kernel/common \
            -b android12-5.10 kernel

      - name: Build Module
        run: |
          # Настройка переменных окружения
          export PATH=$(pwd)/clang/bin:$PATH
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          
          # Переходим в ядро для подготовки
          cd kernel
          
          # Очистка
          make mrproper
          
          # Создаем конфигурацию GKI (Generic Kernel Image)
          make CC=clang LLVM=1 LLVM_IAS=1 gki_defconfig
          
          # === ВАЖНЫЕ ПАТЧИ КОНФИГА ===
          # Отключаем подпись модулей, чтобы не требовались ключи
          sed -i 's/CONFIG_MODULE_SIG=y/CONFIG_MODULE_SIG=n/' .config
          sed -i 's/CONFIG_MODULE_SIG_ALL=y/CONFIG_MODULE_SIG_ALL=n/' .config
          sed -i 's/CONFIG_MODULE_SIG_FORCE=y/CONFIG_MODULE_SIG_FORCE=n/' .config
          
          # Отключаем защиту стека (решает проблему с asm-offsets.h)
          sed -i 's/CONFIG_CC_STACKPROTECTOR_STRONG=y/# CONFIG_CC_STACKPROTECTOR_STRONG is not set/' .config
          sed -i 's/CONFIG_CC_STACKPROTECTOR=y/# CONFIG_CC_STACKPROTECTOR is not set/' .config

          # Обновляем конфиг после правок
          make CC=clang LLVM=1 LLVM_IAS=1 olddefconfig
          
          # Подготавливаем ядро (генерация заголовков)
          make CC=clang LLVM=1 LLVM_IAS=1 modules_prepare
          
          # Возвращаемся в корень
          cd ..
          
          # === СБОРКА МОДУЛЯ ===
          # Используем переменные LLVM=1 для использования clang из PATH
          make -C $(pwd)/kernel \
               M=$(pwd) \
               ARCH=arm64 \
               CC=clang \
               LLVM=1 \
               LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-gnu- \
               modules
          
          # Очистка отладочной информации (уменьшает размер .ko)
          $(pwd)/clang/bin/llvm-objcopy --strip-debug *.ko

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rw_universal.ko
          path: rw_universal.ko

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: rw_universal.ko
          title: Release ${{ github.ref_name }}
