name: Build Kernel Modules (5.10 & 6.1)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Kernel ${{ matrix.kernel_version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Конфигурация для 5.10 (Legacy) ---
          - kernel_version: "5.10-gki"
            branch: "android12-5.10"
            ndk_version: "r25c"
            # Для 5.10 используем старый NDK и стандартные флаги
            setup_ndk_manually: true

          # --- Конфигурация для 6.1 (Android 14) ---
          - kernel_version: "6.1-gki"
            branch: "android14-6.1"
            ndk_version: "r26d"
            # Для 6.1 используем action для NDK r26 (так надежнее)
            setup_ndk_manually: false

    steps:
    - name: Checkout driver source
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev \
                                python3 python3-pip git wget lld llvm libelf-dev

    # --- УСТАНОВКА NDK (Разная логика для 5.10 и 6.1) ---

    # Вариант 1: Для 5.10 (Старый метод)
    - name: Setup Android NDK (Manual r25c)
      if: matrix.setup_ndk_manually == true
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        echo "$GITHUB_WORKSPACE/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    # Вариант 2: Для 6.1 (Новый метод через Action, так как r26 сложнее скачать wget)
    - name: Setup Android NDK (Action r26d)
      if: matrix.setup_ndk_manually == false
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26d
        add-to-path: true

    # --- ПОДГОТОВКА ЯДРА ---

    - name: Clone GKI kernel
      run: |
        git clone --depth 1 --branch ${{ matrix.branch }} https://android.googlesource.com/kernel/common kernel-source

    - name: Integrate Driver
      run: |
        cd kernel-source
        mkdir -p drivers/khack
        cp $GITHUB_WORKSPACE/driver-src/kernel/* drivers/khack/
        
        # Создаем Kconfig/Makefile (как в твоем примере)
        cat > drivers/khack/Kconfig <<-'EOF'
        config KERNEL_HACK
            tristate "JiangNight Memory Hack Driver"
            default m
        EOF
        
        cat > drivers/khack/Makefile <<-'EOF'
        obj-$(CONFIG_KERNEL_HACK) += jiangnight.o
        jiangnight-objs := entry.o 
        EOF
        
        echo 'source "drivers/khack/Kconfig"' >> drivers/Kconfig
        echo 'obj-$(CONFIG_KERNEL_HACK) += khack/' >> drivers/Makefile

    # --- СБОРКА ---

    - name: Build Module
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
        CROSS_COMPILE: aarch64-linux-android-
      run: |
        cd kernel-source
        
        # 1. Базовый конфиг
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS gki_defconfig
        
        # 2. СПЕЦИФИКА 6.1: Исправляем Exec format error (включаем ThinLTO и Modversions)
        if [[ "${{ matrix.kernel_version }}" == "6.1-gki" ]]; then
            echo "Applying 6.1 specific fixes (ThinLTO)..."
            ./scripts/config --file out/.config --enable CONFIG_LTO_CLANG_THIN
            ./scripts/config --file out/.config --disable CONFIG_LTO_CLANG_FULL
            ./scripts/config --file out/.config --enable CONFIG_MODVERSIONS
            # Для 6.1.158 часто нужно явно указать версию (опционально)
            # EXTRA_CFLAGS="-DMODULE_VERMAGIC="6.1.158-g5e6db7045704-dirty SMP preempt mod_unload modversions""
        fi
        
        # 3. Добавляем модуль в конфиг
        echo "CONFIG_KERNEL_HACK=m" >> out/.config
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS olddefconfig
        
        # 4. Подготовка (modules_prepare)
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS -j$(nproc) modules_prepare
        
        # 5. Сборка модуля
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS -j$(nproc) M=drivers/khack
        
        # 6. Стриппинг (уменьшение веса)
        # Ищем файл, так как путь может отличаться
        find out -name "jiangnight.ko" -exec llvm-strip --strip-debug {} ;

    # --- ЗАГРУЗКА РЕЗУЛЬТАТА ---

    - name: Upload module
      uses: actions/upload-artifact@v4
      with:
        name: jiangnight-${{ matrix.kernel_version }}.ko
        path: kernel-source/out/**/jiangnight.ko
        if-no-files-found: error
