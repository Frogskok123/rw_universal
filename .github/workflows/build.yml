name: Build Kernel Modules (5.10 & 6.1)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.kernel-version }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- GKI 5.10 (Android 12/13) ---
          - kernel-version: 5.10-gki
            repo_url: https://android.googlesource.com/kernel/common
            branch: android12-5.10
            config: gki_defconfig
            spoof_vermagic: "false"
            magic_string: ""

          # --- GKI 6.1 (Android 14/15) ---
          - kernel-version: 6.1-gki-dirty
            repo_url: https://android.googlesource.com/kernel/common
            branch: android14-6.1
            config: gki_defconfig
            spoof_vermagic: "true"
            # Строка подмены (из uname -r на твоем устройстве)
            magic_string: "6.1.158-g5e6db7045704-dirty SMP preempt mod_unload modversions"

    steps:
    - name: Checkout driver source
      uses: actions/checkout@v4
      with:
        path: driver-src

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc bison flex libssl-dev \
                                python3 python3-pip git wget lld llvm libelf-dev

    - name: Setup Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        echo "$GITHUB_WORKSPACE/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Clone Kernel Source
      run: |
        git clone --depth 1 --branch ${{ matrix.branch }} ${{ matrix.repo_url }} kernel-source

    - name: Integrate Driver
      run: |
        cd kernel-source
        mkdir -p drivers/khack
        cp $GITHUB_WORKSPACE/driver-src/kernel/* drivers/khack/
        
        # Генерация Kconfig/Makefile для драйвера
        echo 'config KERNEL_HACK' > drivers/khack/Kconfig
        echo '    tristate "Memory Hack"' >> drivers/khack/Kconfig
        echo '    default m' >> drivers/khack/Kconfig
        
        echo 'obj-$(CONFIG_KERNEL_HACK) += jiangnight.o' > drivers/khack/Makefile
        echo 'jiangnight-objs := entry.o' >> drivers/khack/Makefile
        
        echo 'source "drivers/khack/Kconfig"' >> drivers/Kconfig
        echo 'obj-$(CONFIG_KERNEL_HACK) += khack/' >> drivers/Makefile

    - name: Build Module (Fast Mode + Vermagic Override)
      env:
        ARCH: arm64
        LLVM: 1
        LLVM_IAS: 1
        CROSS_COMPILE: aarch64-linux-android-
      run: |
        cd kernel-source
        
        # 1. Config
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS ${{ matrix.config }}
        
        # 2. OPTIMIZATION: Отключаем LTO (Ускоряет сборку в разы)
        ./scripts/config --file out/.config --disable CONFIG_LTO_CLANG
        ./scripts/config --file out/.config --disable CONFIG_LTO
        ./scripts/config --file out/.config --enable CONFIG_LTO_NONE
        
        # 3. Отключаем проверки версий и подписей
        ./scripts/config --file out/.config --disable CONFIG_MODVERSIONS
        ./scripts/config --file out/.config --disable CONFIG_MODULE_SIG
        ./scripts/config --file out/.config --disable CONFIG_MODULE_SIG_FORCE
        
        # 4. Включаем наш модуль в конфиг
        echo "CONFIG_KERNEL_HACK=m" >> out/.config
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS olddefconfig
        
        # 5. Подготовка к сборке
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS -j$(nproc) modules_prepare
        
        # 6. ФОРМИРУЕМ ФЛАГИ (Ключевой момент фикса)
        # Мы передаем VERMAGIC прямо в компилятор, минуя редактирование файлов
        EXTRA_FLAGS="-Wno-array-bounds -Wno-error"
        
        if [ "${{ matrix.spoof_vermagic }}" = "true" ]; then
             echo "Applying Vermagic spoof: ${{ matrix.magic_string }}"
             # Экранирование кавычек для передачи строки с пробелами внутрь макроса C
             EXTRA_FLAGS="$EXTRA_FLAGS -DMODULE_VERMAGIC="\\"${{ matrix.magic_string }}\\"""
        fi
        
        # 7. Сборка самого модуля
        make O=out ARCH=$ARCH LLVM=$LLVM LLVM_IAS=$LLVM_IAS \
             KCFLAGS="$EXTRA_FLAGS" \
             -j$(nproc) M=drivers/khack
        
        # 8. Стриппинг (уменьшение размера)
        llvm-strip --strip-debug out/drivers/khack/*.ko

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: module-${{ matrix.kernel-version }}.ko
        path: kernel-source/out/drivers/khack/*.ko
