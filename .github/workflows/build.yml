name: Build Universal LKM (5.10-android12) - FIXED

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential zip curl libssl-dev python3 git gcc-aarch64-linux-gnu

      - name: Download Toolchain (Proton Clang)
        run: |
          # Используем Proton Clang вместо NDK - это надежнее для ядер
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common \
            -b android12-5.10 kernel

      - name: Prepare Kernel & Build Module
        run: |
          # Настраиваем переменные
          export PATH=$(pwd)/clang/bin:$PATH
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CLANG_TRIPLE=aarch64-linux-gnu-
          
          # 1. Подготовка ядра
          cd kernel
          make mrproper
          
          # Используем gki_defconfig (стандарт для Android 12)
          make CC=clang LLVM=1 LLVM_IAS=1 gki_defconfig
          
          # === ПАТЧИ ДЛЯ ИСПРАВЛЕНИЯ ВАШЕЙ ОШИБКИ ===
          # Отключаем защиту стека. Это убирает требование к asm-offsets.h для канарейки.
          # Именно это исправит "clang-14: error: invalid value '' in 'mstack-protector-guard-offset='"
          sed -i 's/CONFIG_CC_STACKPROTECTOR_STRONG=y/# CONFIG_CC_STACKPROTECTOR_STRONG is not set/' .config
          sed -i 's/CONFIG_CC_STACKPROTECTOR=y/# CONFIG_CC_STACKPROTECTOR is not set/' .config
          
          # Отключаем подпись модулей для упрощения
          sed -i 's/CONFIG_MODULE_SIG=y/CONFIG_MODULE_SIG=n/' .config
          sed -i 's/CONFIG_MODULE_SIG_ALL=y/CONFIG_MODULE_SIG_ALL=n/' .config
          
          # Применяем изменения и готовим заголовки
          make CC=clang LLVM=1 LLVM_IAS=1 olddefconfig
          make CC=clang LLVM=1 LLVM_IAS=1 modules_prepare
          
          # Возвращаемся в корень
          cd ..
          
          # 2. Сборка вашего модуля
          # Важно: передаем CC=clang LLVM=1 чтобы использовался наш тулчейн
          make -C $(pwd)/kernel \
               M=$(pwd) \
               ARCH=arm64 \
               CC=clang \
               LLVM=1 \
               LLVM_IAS=1 \
               CROSS_COMPILE=aarch64-linux-gnu- \
               modules
          
          # Очистка отладочной информации (strip)
          $(pwd)/clang/bin/llvm-objcopy --strip-debug rw_universal.ko

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rw_universal.ko
          path: rw_universal.ko

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: rw_universal.ko
          title: Release ${{ github.ref_name }}
